clear

[EPSC, t] = generate_E(40, 1.5, 3, 120); % Generate simulated excitatory current

% Starting values
Vm = -70;
EChl = -70;
EGlu = 0;

True_values = {40,1.5,3}; % These are the "real" values we'll try to fit

% Initial values for fitting
gmg = 20; tde = 5; tre = 1;

zmax = 50; % number of iterations

% Preallocation
final_Glu = zeros(1,zmax);
final_tau_decay_ex = zeros(1,zmax);
final_tau_rise_ex = zeros(1,zmax);

% 50 iterations
for z = 1:zmax
    
    %% Fit model to data
    % Apply white noise to the EPSC - every time again, in order to have
    % different values for the noise each iteration. You can change the
    % number: the higher the number, the less the noise.
    y = awgn(EPSC,5,'measured');
    
    %% Perform fit
    [xData, yData] = prepareCurveData(t, y);
    % Set up fittype and options.
    ft = fittype( '((G_max_glu) .* ((1 - exp(-t / tau_rise_Ex)) .* exp(-t / tau_decay_Ex)) * (Vm - EGlu))', 'independent', 't', 'dependent', 'y' );
    opts = fitoptions( 'Method', 'NonlinearLeastSquares', 'MaxIter', 5000);
    opts.Display = 'notify';
    
    % Realistic values
    if z == 1 % On the first iteration, we want to get a plot just to have an idea as to what's going on
        opts.Lower      = [0 1   -70 1  1 ];
        opts.StartPoint = [0 gmg  -70 tde tre ]; % Starting values
        opts.Upper      = [0 150 -70 20 5 ]; 
        
        [fitresult1, gof1(z)] = fit(xData, yData, ft, opts)
        
        final_Glu(z) = fitresult1.G_max_glu;
        final_tau_decay_ex(z) = fitresult1.tau_decay_Ex;
        final_tau_rise_ex(z) = fitresult1.tau_rise_Ex;

        % Plot the solution
        EPSC_fit = ((fitresult1.G_max_glu) .* ((1 - exp(-t / fitresult1.tau_rise_Ex)) .* exp(-t / fitresult1.tau_decay_Ex)) * (Vm - EGlu));
        
        %% Plot fit with data
        figure
        plot(t,y)
        hold on
        plot(t,EPSC_fit)
        title("Excitatory current")
        legend("Recorded","Fit")
        
    else % On every subsequent iteration, we add everything to the previous matrices we created
        opts.Lower      = [0 1   -70 1  1 ];
        opts.StartPoint = [0 gmg  -70 tde tre ]; % Starting values [-70 0 gmc gmg -30 tde tdi tre tri];
        opts.Upper      = [0 150 -70 20 5 ];         
        
        [fitresult1, gof1(z)] = fit(xData, yData, ft, opts)
        
        final_Glu(z) = fitresult1.G_max_glu;
        final_tau_decay_ex(z) = fitresult1.tau_decay_Ex;
        final_tau_rise_ex(z) = fitresult1.tau_rise_Ex;
    end
end

% Create one table for each case. Store values for all iterations

T1_f = table(final_Glu', final_tau_rise_ex',final_tau_decay_ex');

T = cell2table(True_values);

% Let's see some statistics
func1 = @(x) mean(x);
func2 = @(x) std(x);

table_ff1(1,:) = varfun(func1,T1_f);
table_ff1(2,:) = varfun(func2,T1_f);

T.Properties.VariableNames = {'Max conductance Glutamate', 'Tau rise Ex', 'Tau Decay Ex'};
table_ff1.Properties.VariableNames = {'Max conductance Glutamate', 'Tau rise Ex', 'Tau Decay Ex'};

table_ff1 = [T;table_ff1];

% In the first row, we see the true values we would want to get with our
% fit. In the second row, we see the average values we get with our fit in
% all the iterations we did. In the third row we look at standard
% deviation 
table_ff1.Properties.RowNames = {'True value','Mean','Std'};
